{"version":1,"ops":[{"type":1,"author":{"id":"04135dc995e2fdcd322aaf4268dbf04630a3cc7c"},"timestamp":1444053697,"metadata":{"github-id":"MDU6SXNzdWUxMDk4MDIzODY=","github-url":"https://github.com/perl11/cperl/issues/63","origin":"github"},"title":"fix broken B::RV-\u003eFLAGS for GVOP_gv -\u003e CVREF","message":"5.22 has a wrong RV-\u003eFLAGS for a GVOP_gv pointing to a CVREF `gv(cv ref: main::skip_on_odd)`.\nIt returns the flags for a GV (0x808009) where it should be just 0x801, a ROK RV.\n\ncompiler testcase 21:\n\n```\n(gdb) p/x *cGVOP_gv\n$11 = {sv_any = 0x10082d370, sv_refcnt = 0x2, sv_flags = 0x801, sv_u = {svu_pv = 0x10082d308,\n    svu_iv = 0x10082d308, svu_uv = 0x10082d308, svu_nv = 0x0, svu_rv = 0x10082d308,\n    svu_rx = 0x10082d308, svu_array = 0x10082d308, svu_hash = 0x10082d308, svu_gp = 0x10082d308,  svu_fp = 0x10082d308}}\n(gdb) sd *sp\nSV = IV(0x10082d370) at 0x10082d380\n  REFCNT = 2\n  FLAGS = (ROK)\n  RV = 0x10082d308\n    SV = PVCV(0x100829e20) at 0x10082d308\n      REFCNT = 1\n      FLAGS = (NAMED)\n      COMP_STASH = 0x1008044d0  \"main\"\n      START = 0x100826d20 ===\u003e 1\n      ROOT = 0x100826c98\n      NAME = \"skip_on_odd\"\n      FILE = \"ccode21.pl\"\n      DEPTH = 0\n      FLAGS = 0x8000\n      OUTSIDE_SEQ = 4294967246\n      PADLIST = 0x10060e960\n        PADNAME = 0x10060e9a0(0x10060e6a0) PAD = 0x10082d320(0x10060e980)\n      OUTSIDE = 0x100804950 (MAIN)\n```\n\nRV-\u003eFLAGS of this returns not 0x801 but 0x808009\n\nrepro:\n\n```\nperl -MB -le'sub xx{$a} xx(1); \n  sub B::SVOP::xx{\n    my $o=shift;\n    printf \"%s\\t-\u003egv flags=%x\\n\", \n      $o-\u003ename, $o-\u003egv-\u003eFLAGS if $o-\u003ecan(\"gv\")} \n  B::walkoptree_slow(B::main_root, \"xx\", 0)'\n\nconst-\u003egv flags=8011101\ngv   -\u003egv flags=801\ngv   -\u003egv flags=808009\nconst-\u003egv flags=18014403\nconst-\u003egv flags=8011101\ngv   -\u003egv flags=808009\n```\n\nwhere this main_root is:\n\n```\n(-e:0)  enter\n(-e:0)  nextstate\n(-e:1)  pushmark\n(-e:1)  const(IV(1))\n(-e:1)  gv(cv ref: main::xx)\n(-e:1)  entersub\n```\n\nEnsure not to call CvGV on a named CV (lexical CV). Always check NAME_HEK before.\n~~Not a core bug, only a compiler bug.~~ But add B documentation, warning of it.\nActually it should be a B bug. $cv-\u003eGV is introspective and should not vivify the GV.\nAdd a PUREGV variant which does not create a GV.","files":null}]}