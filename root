{"version":1,"ops":[{"type":1,"author":{"id":"04135dc995e2fdcd322aaf4268dbf04630a3cc7c"},"timestamp":1460526291,"metadata":{"github-id":"MDU6SXNzdWUxNDc5NTI0NjU=","github-url":"https://github.com/perl11/cperl/issues/134","origin":"github"},"title":"fix @_ corruption in goto sig2pp (global destruction PERL_DESTRUCT_LEVEL=2 only)","message":"in the #7 signatures branch we have this remaining blocker:\n\nAfter a goto from a signatured sub to a pure-perl sub, \n@_ / GvAV(PL_defgv) gets corrupted, which can SEGV/Invalid free in global destruction with PERL_DESTRUCT_LEVEL=2.\nThere are also 2 other GVs being freed wrongly: Attempt to free temp prematurely with *\\x08, $@ and @_.\nThe root cause is cx-\u003eblk_sub.savearray being corrupted:\n\n```\n$ PERL_DESTRUCT_LEVEL=2 gdb --args ./miniperl -DXDlv -Ilib siggoto.t\n...\n(gdb) watch -l PL_defgv-\u003esv_u.svu_gp-\u003egp_av\n\n(54722:siggoto.t:23)    CX 1 POP SUB (scope 3,3) at pp_hot.c:3336\n(54722:siggoto.t:71)    LEAVE scope 3 (savestack=12) at pp_hot.c:3381\n(54722:siggoto.t:71)    savestack: releasing items 12 -\u003e 4\nPad 0x100810638[14] 0x10060b5b0 clearsv: 4 sv=0x100810718\u003c1\u003e clear\nPad 0x100810638[14] 0x10060b5b0 clearsv: 3 sv=0x1008106e0\u003c1\u003e clear\nPad 0x100810638[14] 0x10060b5b0 clearsv: 2 sv=0x1008106a8\u003c1\u003e clear\nPad 0x100810638[14] 0x10060b5b0 clearsv: 1 sv=0x100810670\u003c1\u003e clear\n\nHardware watchpoint 6: -location PL_defgv-\u003esv_u.svu_gp-\u003egp_av\n\nOld value = (AV *) 0x100808ac0\nNew value = (AV *) 0x101805c08\n0x0000000100258fb3 in Perl_pp_leavesub () at pp_hot.c:3382\n3382        POPSUB(cx,sv);  /* Stack values are safe: release CV and @_ ... */\n(gdb) sd 0x101805c08\n$33 = 5521984\nALLOCATED at PDï¿½:8259 for preinc (parent 0x101829bf8); serial 4320303952\nSV = IV(0x100544240) at 0x101805c08\n  REFCNT = 25326928\n  FLAGS = 0x1 ()\n  IV = 0\n```\n\nThis needs to be reverse debugged","files":null}]}