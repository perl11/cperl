{"version":1,"ops":[{"type":1,"author":{"id":"04135dc995e2fdcd322aaf4268dbf04630a3cc7c"},"timestamp":1473881868,"metadata":{"github-id":"MDU6SXNzdWUxNzcwMDAxNDY=","github-url":"https://github.com/perl11/cperl/issues/201","origin":"github"},"title":"fix NODEFAULT_SHAREKEYS","message":"When NODEFAULT_SHAREKEYS is defined, sv_clear of a IsCOW/LEN=0 PV fails to get the he before the hek, which is shared with the pv.\n\nWith default SHAREKEYS every single key is stored twice. Once in strtab, and once in the hash. This seems to be a massive overhead. But I cannot test the overhead with this failure. (=\u003e 20-30% faster)\n\nThis is an upstream bug, typical bitrot. perl5 simply assumes that every single non-strtab hash uses shared keys,  ignoring the HVhek_UNSHARED bit somewhere. Or most likely forgetting to copy this bit.\nNODEFAULT_SHAREKEYS was previously in newHV() in hv.c, added with fde52b5cc5a5093c19adc4c8444d3cef2f199541 in perl 5.003_01\n\nrepro: Configure with `-DDEBUGGING -Accflags=-DNODEFAULT_SHAREKEYS`; \n`make miniperl; ./miniperl -Ilib configpm \u0026\u0026 make uni.data` and see the unshare_hek assert.\nThis even happens with 5.10.0, before new IsCOW times, but works with 5.8.9. So it got broken during the 5.9 cycle, probably with the old COW.","files":null}]}