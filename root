{"version":1,"ops":[{"type":1,"author":{"id":"04135dc995e2fdcd322aaf4268dbf04630a3cc7c"},"timestamp":1498206792,"metadata":{"github-id":"MDU6SXNzdWUyMzgwNzU4MDI=","github-url":"https://github.com/perl11/cperl/issues/298","origin":"github"},"title":"improve nextstate","message":"nextstate is the statement ending op. At every `;` it unnecessarily resets the stack to 0, and unnecessarily calls TMPSFLOOR, and as thus it is by far the slowest op in a normal perl program. \nIt's on average 3x slower than any other op, and it is one of the most often called ops.\n\nSee the branches reset-stack and tmpsfloor, and `Porting/op.d`, L\u003cperldtrace/How much time is spent in an op on average\u003e\n\nreset-stack:  PL_stack_sp = PL_stack_base + CX_CUR()-\u003eblk_oldsp;\nThis is the work of unstack, not nextstate. It should be unnecessary, is slow and is a problem for inlining subs. But we can only implement this with oplines.\n\ntmpsfloor: do it only when PL_tmps_floor != PL_tmps_ix.\n\ndo not store unneeded TMPSFLOOR stack. this happens basically at every single src line (statement). %3 faster.\n\nit might be needed to restore TMPS with non-local exits (failed eval), but tests do not prove this.\nfailing tests: Scalar-List-Utils/t/uniq.t op/sort.t, Hash-Util-FieldHash/t/02_function.t\n\n```\ndtrace -qZn \"BEGIN{self-\u003eprev=0;}\n                op-entry { myop = copyinstr(arg0); curtime = timestamp;\n                           elapsed = self-\u003eprev ? curtime - self-\u003eprev : 0;\n                           @[myop]=avg(elapsed); self-\u003eprev = curtime;}\n                END { trunc(@, 15); printf(\\\"\\nTime (avg ns)\\n\\\");\n                      printa(\\\"%10s\\t%@8u\\n\\\", @);}\"\n          -c'./miniperl -Ilib -E0'\n```\n\n|  Time |(avg ns)|\n|-------|------:|\n|       and     |    3645|\n|     const     |    3765|\n|   aassign     |    3766|\n|     leave     |    4122|\n|     padsv     |    4140|\n|     aelem     |    4869|\n|  iter_ary     |    4884|\n|  pushmark     |    5015|\n| leaveeval     |    5102|\n|  entersub     |    5926|\n|  leavesub     |    6076|\n|        or     |    8193|\n|     enter     |    9338|\n| nextstate     |   32855|\n|    dofile     |   97832|","files":null}]}